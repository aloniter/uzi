הבנתי את הבעיה - כשאתה משנה את השעה של פעילות, היא נשארת באותו מיקום כי המיון מתבצע לפי `timestamp` (זמן ההוספה המקורי) ולא לפי השעה בפועל.

הנה הקוד המעודכן והמלא עם התיקון:

```html
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מעקב עוזי - Live 🐕</title>

    <link rel="apple-touch-icon" href="uzicon.png">
    <link rel="icon" type="image/png" href="uzicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="עוזי">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 10px;
        }
        .app-container { max-width: 500px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; position: relative; }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        #puppyAge { display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; margin-bottom: 5px; }
        .connection-status { position: absolute; top: 10px; right: 10px; width: 12px; height: 12px; border-radius: 50%; background: #4CAF50; animation: pulse 2s infinite; }
        .connection-status.offline { background: #ff4444; animation: none; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }
        .user-indicator { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-size: 12px; }
        .tabs { display: flex; background: #f5f5f5; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: 500; color: #333; }
        .tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .action-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 25px; }
        .action-btn { padding: 20px; border-radius: 15px; border: none; cursor: pointer; font-size: 16px; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 8px; color: white; }
        .action-btn .emoji { font-size: 30px; }
        .action-btn.food { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        .action-btn.sleep { background: linear-gradient(135deg, #5ee7df 0%, #b490ca 100%); }
        .action-btn.play { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .action-btn.training { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .action-btn.pee { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .action-btn.poop { background: linear-gradient(135deg, #cd9cf2 0%, #f6f3ff 100%); color: #333; }
        .action-btn.walk { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .action-btn.vet { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); }
        .history-item { background: #f8f9fa; padding: 12px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .delete-btn, .edit-btn { color: white; border: none; padding: 4px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-left: 5px; }
        .delete-btn { background: #ff4444; }
        .edit-btn { background: #2196F3; }
        .user-switch { display: flex; gap: 10px; margin-bottom: 20px; background: #f0f0f0; padding: 5px; border-radius: 10px; }
        .user-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: transparent; }
        .user-btn.active { background: white; color: #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .note-input { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; resize: none; margin-bottom: 10px; }
        .day-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; border-radius: 10px; margin-bottom: 10px; font-weight: 600; }
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; }
        .modal-buttons { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        .modal-buttons button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; }
        #modalSaveBtn { background-color: #4CAF50; color: white; }
        #modalCancelBtn { background-color: #f44336; color: white; }
        .schedule-item { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-right: 4px solid #667eea; position: relative; display: flex; align-items: center; gap: 15px; }
        .schedule-item.edit-mode { background: #f0f4ff; border: 2px solid #2196F3; display: flex; gap: 5px; }
        .schedule-item .time { font-size: 18px; font-weight: 600; color: #667eea; }
        .schedule-item .activity { color: #333; }
        .schedule-item.edit-mode .delete-schedule-btn { background: #ff4444; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; }
        .schedule-item.edit-mode input[type="time"] { padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-weight: 600; color: #667eea; }
        .schedule-item.edit-mode input[type="text"] { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        #scheduleEditSection button { background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; }
        #historyFilters { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .filter-btn { padding: 8px 15px; border: 1px solid #ddd; border-radius: 20px; background-color: #f0f0f0; cursor: pointer; font-weight: 500; }
        .filter-btn.active { background-color: #667eea; color: white; border-color: #667eea; }
        #addQuestionBtn { width: 100%; padding: 12px; border-radius: 10px; border: none; background: #2196F3; color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .question-item { background: #f8f9fa; padding: 12px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .question-item .text { flex-grow: 1; white-space: pre-wrap; word-wrap: break-word; }
        .question-item .meta { text-align: left; font-size: 12px; color: #666; flex-shrink: 0; }
    </style>
</head>
<body>
    <div class="app-container" id="appContainer">
        <div class="header">
            <div class="connection-status" id="connectionStatus" title="מחובר"></div>
            <div class="user-indicator" id="currentUserDisplay">משתמש: </div>
            <h1>🐕 עוזי</h1>
            <div class="subtitle">
                <span id="puppyAge"></span><br>
                <span style="font-size: 12px;">נולד: 22.6.2025</span>
            </div>
        </div>
        <div class="tabs">
            <div class="tab active" data-tab="record">רישום</div>
            <div class="tab" data-tab="history">היסטוריה</div>
            <div class="tab" data-tab="schedule">לו"ז</div>
            <div class="tab" data-tab="questions">שאלות לתמיר</div>
        </div>
        <div id="record" class="tab-content active">
             <div class="user-switch">
                <button class="user-btn active" data-user="אלון">אלון</button>
                <button class="user-btn" data-user="נעמי">נעמי</button>
            </div>
            <div class="action-buttons">
                <button class="action-btn food" data-type="אוכל" data-emoji="🍖"><span class="emoji">🍖</span><span>אוכל</span></button>
                <button class="action-btn sleep" data-type="שינה" data-emoji="😴"><span class="emoji">😴</span><span>שינה</span></button>
                <button class="action-btn play" data-type="משחק" data-emoji="🎾"><span class="emoji">🎾</span><span>משחק</span></button>
                <button class="action-btn training" data-type="אימון" data-emoji="🎯"><span class="emoji">🎯</span><span>אימון</span></button>
                <button class="action-btn pee" data-type="פיפי" data-emoji="💧"><span class="emoji">💧</span><span>פיפי</span></button>
                <button class="action-btn poop" data-type="קקי" data-emoji="💩"><span class="emoji">💩</span><span>קקי</span></button>
                <button class="action-btn walk" data-type="טיול" data-emoji="🚶"><span class="emoji">🚶</span><span>טיול</span></button>
                <button class="action-btn vet" data-type="וטרינר" data-emoji="🏥"><span class="emoji">🏥</span><span>וטרינר</span></button>
            </div>
            <textarea class="note-input" id="noteInput" placeholder="הוסף הערה (אופציונלי)..." rows="3"></textarea>
        </div>
        <div id="history" class="tab-content">
            <div id="historyFilters"></div>
            <div id="historyList"></div>
        </div>
        <div id="schedule" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="font-size: 18px; font-weight: 600; color: #333;">לוח זמנים יומי</div>
                <button id="editScheduleBtn" style="background: #2196F3; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer;">✏️ ערוך לו"ז</button>
            </div>
            <div id="scheduleItems"></div>
            <div id="scheduleEditSection" style="display: none;">
                <button id="addScheduleItemBtn">➕ הוסף פעילות חדשה</button>
                <button id="saveScheduleBtn" style="background: #4CAF50;">💾 שמור לו"ז</button>
                <button id="resetScheduleBtn" style="background: #ff9800;">🔄 אפס לברירת מחדל</button>
            </div>
        </div>
        <div id="questions" class="tab-content">
            <div style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 15px;">שאלות לתמיר</div>
            <textarea class="note-input" id="questionInput" placeholder="כתוב כאן שאלה..." rows="4"></textarea>
            <button id="addQuestionBtn">➕ הוסף שאלה</button>
            <div id="questionsList" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <h3>עריכת פעילות</h3>
            <label>שעה:</label>
            <input type="time" id="editTime">
            <label>הערה:</label>
            <textarea id="editNote" rows="3"></textarea>
            <div class="modal-buttons">
                <button id="modalCancelBtn">ביטול</button>
                <button id="modalSaveBtn">שמירה</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = 'אלון';
        let activities = [];
        let questions = [];
        let database = null;
        let currentEditId = null;
        let schedule = [];
        let isEditingSchedule = false;
        let currentFilter = 'הכל';

        const defaultSchedule = [
            { time: "06:00", activity: "🌅 השכמה + פיפי ראשון" }, { time: "06:30", activity: "🍖 ארוחת בוקר" },
            { time: "08:00", activity: "🚶 טיול קצר + צרכים" }, { time: "09:00", activity: "🎾 זמן משחק ופעילות" },
            { time: "10:00", activity: "😴 תנומה" }, { time: "12:00", activity: "🍖 ארוחת צהריים" },
            { time: "13:00", activity: "🚶 טיול + צרכים" }, { time: "14:00", activity: "🎯 זמן אימון (5-10 דקות)" },
            { time: "15:00", activity: "😴 מנוחת אחה\"צ" }, { time: "17:00", activity: "🎾 משחק ופעילות" },
            { time: "18:00", activity: "🍖 ארוחת ערב" }, { time: "19:00", activity: "🚶 טיול ערב + צרכים" },
            { time: "21:00", activity: "😴 הכנה לשינת לילה" }, { time: "23:00", activity: "💧 פיפי אחרון לפני השינה" }
        ];
        
        const activityTypes = [
            { type: 'אוכל', emoji: '🍖' }, { type: 'שינה', emoji: '😴' }, { type: 'משחק', emoji: '🎾' }, 
            { type: 'אימון', emoji: '🎯' }, { type: 'פיפי', emoji: '💧' }, { type: 'קקי', emoji: '💩' }, 
            { type: 'טיול', emoji: '🚶' }, { type: 'וטרינר', emoji: '🏥' }
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyDj_SEXQ6irE7RL0_9RNkktzWSzPh8eVys",
            authDomain: "puppy-tracker-82cb0.firebaseapp.com",
            databaseURL: "https://puppy-tracker-82cb0-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "puppy-tracker-82cb0",
            storageBucket: "puppy-tracker-82cb0.firebasestorage.app",
            messagingSenderId: "565635528841",
            appId: "1:565635528841:web:e2bd7f4f10910d1ae1ae58"
        };

        document.addEventListener('DOMContentLoaded', () => {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                setupFirebaseListeners();
            } catch (e) { console.error("Firebase initialization failed:", e); }
            setupEventListeners();
            loadInitialData();
            renderFilterButtons();
        });

        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', () => switchToTab(tab.dataset.tab)));
            document.querySelectorAll('.user-btn').forEach(btn => btn.addEventListener('click', () => switchUser(btn.dataset.user)));
            document.querySelectorAll('.action-btn').forEach(btn => btn.addEventListener('click', () => recordActivity(btn.dataset.type, btn.dataset.emoji)));
            document.getElementById('modalCancelBtn').addEventListener('click', closeEditModal);
            document.getElementById('modalSaveBtn').addEventListener('click', saveActivityChanges);
            document.getElementById('editScheduleBtn').addEventListener('click', toggleScheduleEdit);
            document.getElementById('addScheduleItemBtn').addEventListener('click', addScheduleItem);
            document.getElementById('saveScheduleBtn').addEventListener('click', saveSchedule);
            document.getElementById('resetScheduleBtn').addEventListener('click', resetSchedule);
            document.getElementById('historyFilters').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    handleFilterClick(e.target.dataset.type);
                }
            });
            document.getElementById('addQuestionBtn').addEventListener('click', addQuestion);
        }

        function loadInitialData() {
            if (database) {
                listenToActivities();
                loadSchedule();
                listenToQuestions();
            }
            calculatePuppyAge();
            setInterval(calculatePuppyAge, 3600000);
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) switchUser(savedUser);
        }

        function setupFirebaseListeners() {
            database.ref('.info/connected').on('value', snapshot => {
                document.getElementById('connectionStatus').classList.toggle('offline', !snapshot.val());
            });
        }
        
        function listenToActivities() {
            database.ref('activities').on('value', snapshot => {
                const data = snapshot.val() || {};
                activities = Object.keys(data).map(key => ({ ...data[key], id: key }));
                if (document.getElementById('history').classList.contains('active')) {
                    displayHistory();
                }
            });
        }

        function switchToTab(tabName) {
            document.querySelectorAll('.tab-content, .tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            if (tabName === 'history') displayHistory();
            if (tabName === 'schedule') loadSchedule();
            if (tabName === 'questions') displayQuestions();
        }

        function switchUser(user) {
            currentUser = user;
            document.getElementById('currentUserDisplay').textContent = 'משתמש: ' + user;
            localStorage.setItem('currentUser', user);
            document.querySelectorAll('.user-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.user === user));
        }

        async function recordActivity(type, emoji) {
            if (!database) return alert('לא מחובר ל-Firebase.');
            const activity = {
                type, emoji, user: currentUser,
                note: document.getElementById('noteInput').value,
                time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }),
                date: new Date().toLocaleDateString('he-IL'),
                timestamp: Date.now()
            };
            try {
                await database.ref('activities').push(activity);
                document.getElementById('noteInput').value = '';
                showNotification(`${emoji} ${type} נרשם בהצלחה!`);
                switchToTab('history');
            } catch (error) {
                console.error("Failed to record activity:", error);
                alert(`שגיאה ברישום הפעילות: ${error.message}`);
            }
        }
        
        function renderFilterButtons() {
            const container = document.getElementById('historyFilters');
            let buttonsHTML = `<button class="filter-btn active" data-type="הכל"> הכל </button>`;
            activityTypes.forEach(activity => {
                buttonsHTML += `<button class="filter-btn" data-type="${activity.type}">${activity.emoji} ${activity.type}</button>`;
            });
            container.innerHTML = buttonsHTML;
        }

        function handleFilterClick(filterType) {
            currentFilter = filterType;
            document.querySelectorAll('#historyFilters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === currentFilter);
            });
            displayHistory();
        }
        
        // ✅ פונקציה חדשה להמרת שעה לדקות (למיון)
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // ✅ פונקציה חדשה ליצירת מזהה זמן ייחודי למיון
        function createSortKey(activity) {
            // ממירים תאריך ישראלי (DD.MM.YYYY) לפורמט שניתן למיון
            const dateParts = activity.date.split('.');
            const dateKey = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
            const timeKey = timeToMinutes(activity.time);
            return `${dateKey}-${timeKey.toString().padStart(4, '0')}`;
        }

        function displayHistory() {
            const filteredActivities = (currentFilter === 'הכל') 
                ? activities 
                : activities.filter(act => act.type === currentFilter);

            const grouped = filteredActivities.reduce((acc, act) => {
                (acc[act.date] = acc[act.date] || []).push(act);
                return acc;
            }, {});

            // ✅ ממיינים ימים לפי התאריך בפועל
            const sortedDates = Object.keys(grouped).sort((a, b) => {
                const dateA = a.split('.').reverse().join('-');
                const dateB = b.split('.').reverse().join('-');
                return dateB.localeCompare(dateA);
            });

            const historyList = document.getElementById('historyList');
            if (filteredActivities.length === 0) {
                 historyList.innerHTML = `<div style="text-align: center; color: #999; padding: 20px;">אין פעילויות להצגה עבור "${currentFilter}"</div>`;
                 return;
            }

            historyList.innerHTML = sortedDates.map(date => `
                <div class="day-section">
                    <div class="day-header">${date === new Date().toLocaleDateString('he-IL') ? 'היום' : date}</div>
                    ${grouped[date]
                        .sort((a, b) => timeToMinutes(b.time) - timeToMinutes(a.time)) // ✅ מיון לפי שעה בפועל
                        .map(act => `
                        <div class="history-item">
                            <div style="flex-grow: 1; text-align: right;">
                                <span>${act.emoji} ${act.type}</span>
                                ${act.note ? `<span style="color: #666; font-size: 12px; display: block;">(${act.note})</span>` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                                <span class="time">${act.time}</span>
                                <span class="user">${act.user}</span>
                                <button class="edit-btn" onclick="openEditModal('${act.id}')">ערוך</button>
                                <button class="delete-btn" onclick="deleteActivity('${act.id}')">מחק</button>
                            </div>
                        </div>`).join('')}
                </div>`).join('');
        }

        async function deleteActivity(id) {
            if (confirm('האם למחוק את הפעילות?')) {
                try { await database.ref(`activities/${id}`).remove(); } catch (e) { alert(`שגיאת מחיקה: ${e.message}`); }
            }
        }
        
        function openEditModal(id) {
            const activity = activities.find(act => act.id === id);
            if (!activity) return;
            currentEditId = id;
            document.getElementById('editTime').value = activity.time;
            document.getElementById('editNote').value = activity.note || '';
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        async function saveActivityChanges() {
            if (!currentEditId) return;
            const newTime = document.getElementById('editTime').value;
            const updates = {
                time: newTime,
                note: document.getElementById('editNote').value
            };
            
            try {
                await database.ref(`activities/${currentEditId}`).update(updates);
                closeEditModal();
                showNotification('הפעילות עודכנה בהצלחה!');
            } catch (e) { 
                alert(`שגיאת עדכון: ${e.message}`); 
            }
        }
        
        function calculatePuppyAge() {
            const birthDate = new Date(2025, 5, 22);
            const today = new Date();

            if (today < birthDate) {
                const diffDays = Math.ceil((birthDate - today) / (1000 * 60 * 60 * 24));
                document.getElementById('puppyAge').textContent = `עוד ${diffDays} ${diffDays === 1 ? 'יום' : 'ימים'}`;
                return;
            }

            let years = today.getFullYear() - birthDate.getFullYear();
            let months = today.getMonth() - birthDate.getMonth();
            let days = today.getDate() - birthDate.getDate();

            if (days < 0) {
                months--;
                const lastDayOfPrevMonth = new Date(today.getFullYear(), today.getMonth(), 0).getDate();
                days += lastDayOfPrevMonth;
            }

            if (months < 0) {
                years--;
                months += 12;
            }

            months += years * 12;

            let ageParts = [];
            if (months > 0) {
                ageParts.push(`${months} ${months === 1 ? 'חודש' : 'חודשים'}`);
            }
            if (days > 0) {
                ageParts.push(`${days} ${days === 1 ? 'יום' : 'ימים'}`);
            }
            
            let ageText;
            if (ageParts.length === 0) {
                ageText = 'היום נולד!';
            } else {
                ageText = `בן ${ageParts.join(' ו')}`;
            }

            document.getElementById('puppyAge').textContent = ageText;
        }

        function loadSchedule() {
            if (!database) return;
            database.ref('schedule').once('value', snapshot => {
                const data = snapshot
                .val();
                schedule = data ? data : JSON.parse(JSON.stringify(defaultSchedule));
                displaySchedule();
            });
        }
        function displaySchedule() {
            const container = document.getElementById('scheduleItems');
            schedule.sort((a, b) => a.time.localeCompare(b.time));
            container.innerHTML = schedule.map((item, index) => {
                if (isEditingSchedule) {
                    return `
                    <div class="schedule-item edit-mode">
                        <input type="time" value="${item.time}" onchange="updateScheduleItem(${index}, 'time', this.value)">
                        <input type="text" value="${item.activity}" onchange="updateScheduleItem(${index}, 'activity', this.value)" placeholder="תיאור הפעילות...">
                        <button class="delete-schedule-btn" onclick="removeScheduleItem(${index})">🗑️</button>
                    </div>`;
                }
                return `
                    <div class="schedule-item">
                        <div class="time">${item.time}</div>
                        <div class="activity">${item.activity}</div>
                    </div>`;
            }).join('');
        }
        function toggleScheduleEdit() {
            isEditingSchedule = !isEditingSchedule;
            document.getElementById('editScheduleBtn').textContent = isEditingSchedule ? '❌ בטל עריכה' : '✏️ ערוך לו"ז';
            document.getElementById('scheduleEditSection').style.display = isEditingSchedule ? 'block' : 'none';
            displaySchedule();
        }
        function updateScheduleItem(index, key, value) { schedule[index][key] = value; }
        function removeScheduleItem(index) {
            if (confirm('למחוק את הפעילות מהלו"ז?')) {
                schedule.splice(index, 1);
                displaySchedule();
            }
        }
        function addScheduleItem() {
            schedule.push({ time: "12:00", activity: "פעילות חדשה" });
            displaySchedule();
        }
        async function saveSchedule() {
            if (!database) return;
            try {
                await database.ref('schedule').set(schedule);
                showNotification('הלו"ז נשמר בהצלחה!');
                toggleScheduleEdit();
            } catch (e) { alert(`שגיאה בשמירת הלו"ז: ${e.message}`); }
        }
        function resetSchedule() {
            if (confirm('לאפס את הלו"ז לברירת המחדל?')) {
                schedule = JSON.parse(JSON.stringify(defaultSchedule));
                displaySchedule();
            }
        }
        
        function listenToQuestions() {
            database.ref('questions').on('value', snapshot => {
                const data = snapshot.val() || {};
                questions = Object.keys(data).map(key => ({ ...data[key], id: key })).sort((a, b) => b.timestamp - a.timestamp);
                if (document.getElementById('questions').classList.contains('active')) {
                    displayQuestions();
                }
            });
        }
        async function addQuestion() {
            const questionInput = document.getElementById('questionInput');
            const questionText = questionInput.value.trim();
            if (!questionText) {
                alert("יש לכתוב שאלה.");
                return;
            }
            if (!database) return alert('לא מחובר ל-Firebase.');
            const question = {
                text: questionText,
                user: currentUser,
                date: new Date().toLocaleDateString('he-IL'),
                timestamp: Date.now()
            };
            try {
                await database.ref('questions').push(question);
                questionInput.value = '';
                showNotification(`שאלה נוספה בהצלחה!`);
            } catch (error) {
                console.error("Failed to add question:", error);
                alert(`שגיאה בהוספת השאלה: ${error.message}`);
            }
        }
        function displayQuestions() {
            const container = document.getElementById('questionsList');
            if (questions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">אין עדיין שאלות</div>';
                return;
            }
            container.innerHTML = questions.map(q => `
                <div class="question-item">
                    <div class="text">${q.text}</div>
                    <div class="meta">
                        <div>${q.date}</div>
                        <div>${q.user}</div>
                        <button class="delete-btn" onclick="deleteQuestion('${q.id}')" style="margin-top: 5px;">מחק</button>
                    </div>
                </div>
            `).join('');
        }
        async function deleteQuestion(id) {
            if (confirm('האם למחוק את השאלה?')) {
                try {
                    await database.ref(`questions/${id}`).remove();
                } catch (e) {
                    alert(`שגיאת מחיקה: ${e.message}`);
                }
            }
        }

        function showNotification(message) {
            const el = document.createElement('div');
            el.style.cssText = `position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; padding: 12px 24px; border-radius: 10px; z-index: 1001;`;
            el.textContent = message;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
    </script>
</body>
</html>
